<!DOCTYPE html>
<html>
<head>
    <title>FIFA/FUT Trading Gaps</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        select, input, button {
            margin-bottom: 10px;
            padding: 5px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            text-align: left;
            padding: 10px;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .price-filter {
            display: inline-block;
            margin-right: 10px;
        }
        .price-filter input {
            width: 80px;
        }
        .favorite {
            color: gold;
            cursor: pointer;
        }
        #last_change_times {
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="loading" style="display: none;">Loading...</div>
    <div style="margin-bottom: 20px;">
        <select id="url_select" onchange="refreshData()" style="padding: 10px;">
            <option value="204">Hunter</option>
            <option value="200">Shadow</option>
            <option value="202">Anchor</option>
        </select>
        <input type="checkbox" id="show_all" onchange="refreshData()"> Show All
        <input type="checkbox" id="use_avg" onchange="refreshData()"> Use Avg Price
        <input type="checkbox" id="max_buy_filter" onchange="applySearch()"> Max Buy > Current Price
        <button onclick="refreshData()" style="padding: 10px;">Refresh</button>
        <button onclick="setGapMode('min_sell')">Gap: Min Sell - Current Price</button>
        <button onclick="setGapMode('max_buy')">Gap: Max Buy - Current Price</button>
        <button onclick="setGapMode('max_min_sell')">Gap: Max Buy - Min Sell</button>
    </div>
    <div>
        <div class="price-filter">
            Current Price: 
            <input type="number" id="current_price_min" placeholder="Min" oninput="applySearch()">
            <input type="number" id="current_price_max" placeholder="Max" oninput="applySearch()">
        </div>
        <div class="price-filter">
            Avg Price: 
            <input type="number" id="avg_price_min" placeholder="Min" oninput="applySearch()">
            <input type="number" id="avg_price_max" placeholder="Max" oninput="applySearch()">
        </div>
    </div>
    <div>
        <label for="tax_rate">EA Tax Rate (%): </label>
        <input type="number" id="tax_rate" value="5" min="0" max="100" step="0.1" onchange="applySearch()">
    </div>
    <div id="favorites"></div>
    <input type="text" id="search" placeholder="Search" oninput="applySearch()" style="width: 100%; padding: 10px;">
    <div id="time_since_last_refresh"></div>
    <div id="last_change_times"></div>
    <table id="data_table">
        <!-- Data will be populated here -->
    </table>
    <script>
        let currentData = [];
        let sortOrder = {column: 6, ascending: false};
        let lastRefreshTime = new Date();
        let gapMode = 'min_sell';
        let favorites = new Set();
        let lastChangeTimes = {
            '204': null, // Hunter
            '200': null, // Shadow
            '202': null  // Anchor
        };
        let previousData = {
            '204': null,
            '200': null,
            '202': null
        };

        function setGapMode(mode) {
            gapMode = mode;
            refreshData();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function calculateProfit(buyPrice, sellPrice, taxRate) {
            const revenue = sellPrice * (1 - taxRate / 100);
            return Math.floor(revenue - buyPrice);
        }

        function toggleFavorite(playerName) {
            if (favorites.has(playerName)) {
                favorites.delete(playerName);
            } else {
                favorites.add(playerName);
            }
            localStorage.setItem('favorites', JSON.stringify(Array.from(favorites)));
            applySearch();
            updateFavoritesList();
        }

        function updateFavoritesList() {
            const favoritesDiv = document.getElementById('favorites');
            favoritesDiv.innerHTML = '<h3>Favorites:</h3>';
            favorites.forEach(player => {
                const playerSpan = document.createElement('span');
                playerSpan.textContent = player + ' ';
                playerSpan.onclick = () => toggleFavorite(player);
                playerSpan.style.cursor = 'pointer';
                favoritesDiv.appendChild(playerSpan);
            });
        }

        function populateTable(data) {
            currentData = data;
            const arrow = sortOrder.ascending ? '↓' : '↑';
            const table = document.getElementById('data_table');
            table.innerHTML = `<tr>
                <th onclick="sortTable(1)">Player</th>
                <th onclick="sortTable(2)">Max Buy</th>
                <th onclick="sortTable(3)">Min Sell</th>
                <th onclick="sortTable(4)">Current Price</th>
                <th onclick="sortTable(5)">Avg Price</th>
                <th onclick="sortTable(6)">Gap ${sortOrder.column === 6 ? arrow : ''}</th>
                <th>Potential Profit</th>
                <th>Favorite</th>
            </tr>`;
            applySearch();
        }

        function applySearch() {
            const table = document.getElementById('data_table');
            const searchValue = document.getElementById('search').value.toLowerCase();
            const maxBuyFilter = document.getElementById('max_buy_filter').checked;
            const currentPriceMin = parseFloat(document.getElementById('current_price_min').value) || -Infinity;
            const currentPriceMax = parseFloat(document.getElementById('current_price_max').value) || Infinity;
            const avgPriceMin = parseFloat(document.getElementById('avg_price_min').value) || -Infinity;
            const avgPriceMax = parseFloat(document.getElementById('avg_price_max').value) || Infinity;
            const taxRate = parseFloat(document.getElementById('tax_rate').value) || 5;

            let filteredData = currentData.filter(row => {
                const currentPrice = row[3];
                const avgPrice = row[4];
                return (
                    row.some(cell => cell.toString().toLowerCase().includes(searchValue)) &&
                    (!maxBuyFilter || row[1] > row[3]) &&
                    currentPrice >= currentPriceMin && currentPrice <= currentPriceMax &&
                    (avgPrice === null || (avgPrice >= avgPriceMin && avgPrice <= avgPriceMax))
                );
            });

            table.innerHTML = table.querySelector('tr').outerHTML;
            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell ?? 'N/A';
                    tr.appendChild(td);
                });
                
                // Add potential profit column
                const profitTd = document.createElement('td');
                const profit = calculateProfit(row[3], row[2], taxRate);
                profitTd.textContent = profit;
                tr.appendChild(profitTd);

                // Add favorite column
                const favoriteTd = document.createElement('td');
                const favoriteSpan = document.createElement('span');
                favoriteSpan.textContent = favorites.has(row[0]) ? '★' : '☆';
                favoriteSpan.className = 'favorite';
                favoriteSpan.onclick = () => toggleFavorite(row[0]);
                favoriteTd.appendChild(favoriteSpan);
                tr.appendChild(favoriteTd);

                table.appendChild(tr);
            });
        }

        function sortTable(columnIndex) {
            currentData.sort((a, b) => {
                const valA = a[columnIndex - 1];
                const valB = b[columnIndex - 1];
                let comparison = 0;
                if (valA === null && valB === null) {
                    comparison = 0;
                } else if (valA === null) {
                    comparison = 1;
                } else if (valB === null) {
                    comparison = -1;
                } else if (valA > valB) {
                    comparison = 1;
                } else if (valA < valB) {
                    comparison = -1;
                }
                return sortOrder.ascending ? comparison : -comparison;
            });
            sortOrder = {column: columnIndex, ascending: !sortOrder.ascending};
            populateTable(currentData);
        }

        function updateLastChangeTime(articleNumber, newData) {
            if (JSON.stringify(newData) !== JSON.stringify(previousData[articleNumber])) {
                lastChangeTimes[articleNumber] = new Date();
                previousData[articleNumber] = newData;
            }
            updateLastChangeTimesDisplay();
        }

        function updateLastChangeTimesDisplay() {
            const lastChangeTimesDiv = document.getElementById('last_change_times');
            const now = new Date();
            let html = '<strong>Time since last data change:</strong><br>';
            for (const [articleNumber, lastChangeTime] of Object.entries(lastChangeTimes)) {
                const chemStyle = articleNumber === '204' ? 'Hunter' : articleNumber === '200' ? 'Shadow' : 'Anchor';
                if (lastChangeTime) {
                    const diffInSeconds = Math.floor((now - lastChangeTime) / 1000);
                    html += `${chemStyle}: ${diffInSeconds} seconds ago<br>`;
                } else {
                    html += `${chemStyle}: No changes recorded yet<br>`;
                }
            }
            lastChangeTimesDiv.innerHTML = html;
        }

        function refreshData() {
            showLoading();
            const article_number = document.getElementById('url_select').value;
            const show_all = document.getElementById('show_all').checked;
            const use_avg = document.getElementById('use_avg').checked;
            const formData = new URLSearchParams();
            formData.append('article_number', article_number);
            formData.append('show_all', show_all);
            formData.append('gap_mode', gapMode);
            formData.append('use_avg', use_avg);
            fetch('/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    updateLastChangeTime(article_number, data.data);
                    populateTable(data.data);
                    lastRefreshTime = new Date();
                }
                hideLoading();
            })
            .catch(error => {
                alert(`An error occurred: ${error}`);
                hideLoading();
            });
        }

        window.onload = () => {
            favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));
            updateFavoritesList();
            refreshData();
            setInterval(refreshData, 5 * 60 * 1000);
            setInterval(() => {
                const now = new Date();
                const diffInSeconds = Math.floor((now - lastRefreshTime) / 1000);
                document.getElementById('time_since_last_refresh').textContent = `Last refreshed: ${diffInSeconds} seconds ago`;
                updateLastChangeTimesDisplay();
            }, 1000);
        };
    </script>
</body>
</html>